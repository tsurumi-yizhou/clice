import{_ as t,c as a,o as r,ae as i}from"./chunks/framework.U1Gow_7P.js";const u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"design/design.md","filePath":"en/design/design.md"}'),n={name:"design/design.md"};function o(l,e,s,c,h,d){return r(),a("div",null,e[0]||(e[0]=[i('<p>&quot;architectural issue&quot; here actually means the issue which can be solved but need to make a lot of modification to clangd. Currently, such big modification can be hard to push because of lack resource in clangd as mentioned <a href="https://github.com/clangd/clangd/issues/1690#issuecomment-1619735578" target="_blank" rel="noreferrer">here</a>. I am a university student, also a c++ enthusiast and a vscode user. So I have a lot of time that I can dedicate to things I am interested in.. At first, I just want to wonder whether I can make some efforts to clangd. But gradually, I found it could be better to rewrite a new LSP. After evaluating the project scale, I think it&#39;s possible to complete for just one person (about 4w~ lines and ccls is also written by one person). Then I start to dive into clangd source code and learn the clang base. So far, I have known how to build preamble, how to build AST, how to traverse AST and so on. All of them are done with clang&#39;s C++ API. Next step is putting them together into final program. However, before the actual implementation, I need to plan out its structure.</p><p>At first, how to manage message? LSP is also a type of server, and the common event-driven model is sufficient. I plan to use libuv as the event library, with the main thread handling requests and distributing tasks, while the thread pool executes the actual tasks. This is slightly different from clangd&#39;s current model; clangd doesn&#39;t use a thread pool, but rather creates a new thread for each file and uses semaphore to limit the number of active threads.</p><p>Then we need to handle TU. I decided to use a different policy with clangd, which is not to build the preamble for the file until the first edit, and headers will reuse the AST in the source file by default, also until first edit. In this way, we can reduce a lot of memory usage, speed up the loading (building preamble always needs more time compared to normal AST building) and support non self contained header. This can be very useful, people actually only need to modify a few files in big projects like LLVM. And today I found Sam also reported this <a href="https://github.com/clangd/clangd/issues/391" target="_blank" rel="noreferrer">issue</a>. Another important problem is how to interact with C++20 modules, I am still exploring this.</p><p>Next is about indexing, current indexer in clangd seems to be efficient enough, so I think I would reuse it and make only some small modifications to record more information. Also, I am wondering whether we can modify the absolute path to relative path in the index, so issue like <a href="https://github.com/clangd/clangd/issues/587" target="_blank" rel="noreferrer">support offline background index preparation</a>。It shouldn&#39;t be hard to implement.</p><p>Following is discussion on some specific LSP features:</p><h2 id="semantic-highlight" tabindex="-1">Semantic Highlight <a class="header-anchor" href="#semantic-highlight" aria-label="Permalink to &quot;Semantic Highlight&quot;">​</a></h2><p>There are several issues around it.</p><ul><li><a href="https://github.com/clangd/clangd/issues/1115" target="_blank" rel="noreferrer">provide semantic information for each token</a></li><li><a href="https://github.com/clangd/clangd/issues/358" target="_blank" rel="noreferrer">no AST node for explicit template instantiations</a></li><li><a href="https://github.com/clangd/clangd/issues/501" target="_blank" rel="noreferrer">class name does not get a coloring in constructor call </a></li><li><a href="https://github.com/clangd/clangd/issues/536" target="_blank" rel="noreferrer">store implicit specializations as distinct symbols in the index, with their own refs</a></li><li><a href="https://github.com/clangd/clangd/issues/787" target="_blank" rel="noreferrer">distinguish between type template parameter and non-type template parameter highlightings</a></li><li><a href="https://github.com/clangd/clangd/issues/872" target="_blank" rel="noreferrer">modifiers are wrong in semantic token for destructor</a></li></ul><p>Mainly about wrong or not enough information in the semantic highlight. I would like to support detail information for each token, then we can solve all of them.</p><h2 id="hint" tabindex="-1">Hint <a class="header-anchor" href="#hint" aria-label="Permalink to &quot;Hint&quot;">​</a></h2><ul><li><a href="https://github.com/clangd/clangd/issues/824" target="_blank" rel="noreferrer">simplify inlay hints</a></li><li><a href="https://github.com/clangd/clangd/issues/1357" target="_blank" rel="noreferrer">make the type hint length limit configurable</a></li><li><a href="https://github.com/clangd/clangd/issues/1535" target="_blank" rel="noreferrer">support go-to-definition on type names in inlay hints</a></li><li><a href="https://github.com/clangd/clangd/issues/542" target="_blank" rel="noreferrer">use namespace alias but not original namespace name</a></li><li><a href="https://github.com/clangd/clangd/issues/1661" target="_blank" rel="noreferrer">support folding range on directive</a></li><li><a href="https://github.com/clangd/clangd/issues/564" target="_blank" rel="noreferrer">documentation for struct member fields not working correctly</a></li><li><a href="https://github.com/clangd/clangd/issues/747" target="_blank" rel="noreferrer">make the hover box more compact</a></li><li><a href="https://github.com/clangd/clangd/issues/923" target="_blank" rel="noreferrer">padding inlay hints</a></li><li><a href="https://github.com/clangd/clangd/issues/959" target="_blank" rel="noreferrer">struct members and enum values are not shown on type hover</a></li><li><a href="https://github.com/clangd/clangd/issues/1016" target="_blank" rel="noreferrer">show length of string literal in hover</a></li><li><a href="https://github.com/clangd/clangd/issues/1163" target="_blank" rel="noreferrer">show type hints for init-captures</a></li></ul><p>Most of these problems are about hint. Providing options to allow users to configure them will be fine.</p><h2 id="action" tabindex="-1">Action <a class="header-anchor" href="#action" aria-label="Permalink to &quot;Action&quot;">​</a></h2><ul><li><a href="https://github.com/clangd/clangd/issues/445" target="_blank" rel="noreferrer">add implementation</a></li><li><a href="https://github.com/clangd/clangd/issues/466" target="_blank" rel="noreferrer">revert if</a></li><li><a href="https://github.com/clangd/clangd/issues/454" target="_blank" rel="noreferrer">move constructor argument into member</a></li><li><a href="https://github.com/clangd/clangd/issues/460" target="_blank" rel="noreferrer">modify function parameters</a></li><li><a href="https://github.com/clangd/clangd/issues/820" target="_blank" rel="noreferrer">expand macro one level</a></li></ul><p>Providing more actions will be helpful.</p><h2 id="code-completion" tabindex="-1">Code Completion <a class="header-anchor" href="#code-completion" aria-label="Permalink to &quot;Code Completion&quot;">​</a></h2><ul><li><a href="https://github.com/clangd/clangd/issues/443" target="_blank" rel="noreferrer">improve code completion inside template</a></li><li><a href="https://github.com/clangd/clangd/issues/493" target="_blank" rel="noreferrer">resolve the type of lambda auto parameters</a></li><li><a href="https://github.com/clangd/clangd/issues/678" target="_blank" rel="noreferrer">don&#39;t include template completion when inside the template class</a></li><li><a href="https://github.com/clangd/clangd/issues/727" target="_blank" rel="noreferrer">can I disable snippet</a></li><li><a href="https://github.com/clangd/clangd/issues/880" target="_blank" rel="noreferrer">no completion for definition of non-public member functions</a></li><li><a href="https://github.com/clangd/clangd/issues/753" target="_blank" rel="noreferrer">outside function definition won&#39;t complete default arguments</a></li><li><a href="https://github.com/clangd/clangd/issues/850" target="_blank" rel="noreferrer">postfix completions</a></li><li><a href="https://github.com/clangd/clangd/issues/893" target="_blank" rel="noreferrer">list free functions alongside methods in autocompletion</a></li><li><a href="https://github.com/clangd/clangd/issues/897" target="_blank" rel="noreferrer">type information lost during auto deduction in templates</a></li><li><a href="https://github.com/clangd/clangd/issues/965" target="_blank" rel="noreferrer">completion member field listing order w.r.t. C++20 designated initializers</a></li><li><a href="https://github.com/clangd/clangd/issues/968" target="_blank" rel="noreferrer">completion of pointers to functions and function objects</a></li></ul><p>These issues around code completion could be hardest to resolve. We need to modify the <code>Parser</code> and <code>SemaComplete</code> in clang to support them. Some are about templates, improving <code>HeuristicResolver</code> will resolve them.</p>',18)]))}const m=t(n,[["render",o]]);export{u as __pageData,m as default};
